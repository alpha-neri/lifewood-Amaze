<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lifewood | Admin Dashboard</title>
    <link rel="icon" href="lifewood.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="css/adminpage.css">
    
    <!-- External Libraries -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Load Firebase Config Separately -->
    <script src="js/firebase-config.js"></script>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="admin-sidebar" id="sidebar">
            <div class="sidebar-header"><a href="index.html" class="nav-logo"><span class="logo-icon"></span>lifewood</a></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a data-view="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                    <li><a data-view="applications"><i class="fas fa-briefcase"></i> <span>Job Applications</span><span class="badge" id="application-count-badge">0</span></a></li>
                    <li><a data-view="listings"><i class="fas fa-list-ul"></i> <span>Job Listings</span></a></li>
                    <li><a class="coming-soon-link"><i class="fas fa-envelope"></i> <span>Contact Messages</span></a></li>
                    <li><a class="coming-soon-link"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><a class="logout-btn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></div>
        </aside>

        <main class="main-content" id="main-content">
            <header class="main-header">
                <div class="header-left">
                    <button class="mobile-menu-toggle" id="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
                    <h1 id="main-header-title">Dashboard</h1>
                </div>
                <div class="user-profile"><span>Welcome, Admin</span><div class="avatar"><i class="fas fa-user"></i></div></div>
            </header>

            <!-- ==== VIEW 1: DASHBOARD ==== -->
            <div id="view-dashboard" class="view-panel active">
                <section class="stats-grid">
                     <div class="stat-card">
                        <div class="stat-icon icon-total"><i class="fas fa-users"></i></div>
                        <div class="stat-info"><span class="stat-value" id="total-applicants-stat">0</span><span class="stat-title">Total Applicants</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon icon-accepted"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-info"><span class="stat-value" id="accepted-stat">0</span><span class="stat-title">Accepted</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon icon-rejected"><i class="fas fa-times-circle"></i></div>
                        <div class="stat-info"><span class="stat-value" id="rejected-stat">0</span><span class="stat-title">Rejected</span></div>
                    </div>
                     <div class="stat-card">
                        <div class="stat-icon icon-pending"><i class="fas fa-clock"></i></div>
                        <div class="stat-info"><span class="stat-value" id="pending-stat">0</span><span class="stat-title">Pending Review</span></div>
                    </div>
                     <div class="stat-card">
                        <div class="stat-icon icon-positions"><i class="fas fa-briefcase"></i></div>
                        <div class="stat-info"><span class="stat-value" id="positions-stat">0</span><span class="stat-title">Unique Positions</span></div>
                    </div>
                </section>
                <section class="content-panel">
                    <div class="panel-header"><h3>Recent Job Applications</h3></div>
                    <div class="table-responsive">
                        <table id="dashboard-applications-table">
                            <thead><tr><th>Applicant Name</th><th>Position</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- ==== VIEW 2: JOB APPLICATIONS ==== -->
            <div id="view-applications" class="view-panel">
                <section class="content-panel">
                    <div class="panel-header"><h3>All Applications</h3></div>
                    <div class="table-responsive">
                        <table id="full-applications-table">
                            <thead><tr><th>Applicant Name</th><th>Position</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- ==== VIEW 3: JOB LISTINGS ==== -->
            <div id="view-listings" class="view-panel">
                <section class="content-panel">
                    <div class="panel-header">
                        <h3>Manage Job Listings</h3>
                        <button class="btn-action" id="add-new-job-btn" style="background-color: var(--accent-primary);"><i class="fas fa-plus"></i> Add New Job</button>
                    </div>
                    <div class="job-listings-grid" id="job-listings-grid">
                        <!-- Job listing cards will be dynamically inserted here -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- VIEW DETAILS MODAL -->
    <div class="modal-overlay" id="view-details-modal-overlay">
        <div class="modal" id="view-details-modal">
            <div class="modal-header"><h3>Application Details</h3><button class="modal-close" id="view-details-close-btn">×</button></div>
            <div class="modal-body details-modal-body">
                <div class="detail-field" id="interview-status-field">
                    <span class="detail-label">Interview Status</span>
                    <span class="detail-value" id="detail-interview-status">-</span>
                </div>
                <div class="detail-field"><span class="detail-label">Full Name</span><span class="detail-value" id="detail-name">-</span></div>
                <div class="detail-field"><span class="detail-label">Email</span><span class="detail-value" id="detail-email">-</span></div>
                <div class="detail-field"><span class="detail-label">Age</span><span class="detail-value" id="detail-age">-</span></div>
                <div class="detail-field"><span class="detail-label">Highest Degree</span><span class="detail-value" id="detail-degree">-</span></div>
                <div class="detail-field"><span class="detail-label">Resume Link</span><span class="detail-value" id="detail-resume">-</span></div>
                <div class="detail-field"><span class="detail-label">Relevant Experience</span><div class="detail-value-experience" id="detail-experience">-</div></div>
            </div>
        </div>
    </div>

    <!-- SCHEDULE INTERVIEW MODAL -->
    <div class="modal-overlay" id="schedule-modal-overlay">
        <div class="modal" id="schedule-modal">
            <div class="modal-header"><h3>Schedule Interview</h3><button class="modal-close" id="schedule-modal-close-btn">×</button></div>
            <div class="modal-body">
                <form id="schedule-form">
                    <div class="schedule-form-group">
                        <label for="interview-date">Interview Date</label>
                        <input type="date" id="interview-date" required>
                    </div>
                    <div class="schedule-form-group">
                        <label for="interview-time">Interview Time</label>
                        <input type="time" id="interview-time" required>
                    </div>
                    <div class="schedule-form-group">
                        <label for="interview-method">Interview Method</label>
                        <select id="interview-method" required>
                            <option value="Google Meet">Google Meet Call</option>
                            <option value="Zoom">Zoom Call</option>
                            <option value="Phone Call">Phone Call</option>
                            <option value="In-Person at Office">In-Person at Office</option>
                        </select>
                    </div>
                    <div class="schedule-modal-actions">
                        <button type="submit" class="btn-confirm-schedule" id="confirm-schedule-btn">Confirm & Send Invite</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JOB LISTING MODAL (FOR ADD/EDIT) -->
    <div class="modal-overlay" id="job-listing-modal-overlay">
        <div class="modal" id="job-listing-modal">
            <div class="modal-header">
                <h3 id="job-listing-modal-title">Add New Job</h3>
                <button class="modal-close" id="job-listing-modal-close-btn">×</button>
            </div>
            <div class="modal-body">
                <form id="job-listing-form">
                    <input type="hidden" id="job-listing-id">
                    <div class="form-group">
                        <label for="job-title">Job Title</label>
                        <input type="text" id="job-title" placeholder="e.g., Senior Frontend Developer" required>
                    </div>
                    <div class="form-group">
                        <label for="job-location">Location</label>
                        <input type="text" id="job-location" placeholder="e.g., San Francisco, CA or Remote" required>
                    </div>
                    <div class="form-group">
                        <label for="job-type">Job Type</label>
                        <select id="job-type" required>
                            <option value="Full-time">Full-time</option>
                            <option value="Part-time">Part-time</option>
                            <option value="Contract">Contract</option>
                            <option value="Internship">Internship</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="job-description">Job Description</label>
                        <textarea id="job-description" rows="8" placeholder="Enter the full job description, responsibilities, and requirements here." required></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn-save-job" id="save-job-btn">Save Job</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPT TAGS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Authentication Gatekeeper ---
        window.addEventListener('pageshow', function(event) {
            if (event.persisted && !auth.currentUser) {
                window.location.reload();
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                initializeDashboard(user);
            } else {
                window.location.replace('admin.html');
            }
        });

        function initializeDashboard(user) {
            emailjs.init('yXnRaoxKZm9Y31L2-'); // Your EmailJS Public Key
            
            const mainContent = document.getElementById('main-content');
            const sidebar = document.getElementById('sidebar');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const logoutBtn = document.querySelector('.logout-btn');
            const mainHeaderTitle = document.getElementById('main-header-title');
            const showToast = (icon, title) => Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true }).fire({ icon, title });

            // --- Sidebar & View Switching ---
            document.querySelectorAll('.sidebar-nav a[data-view]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.sidebar-nav a[data-view]').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    document.querySelectorAll('.view-panel').forEach(panel => panel.classList.remove('active'));
                    document.getElementById(`view-${link.dataset.view}`).classList.add('active');
                    mainHeaderTitle.textContent = link.querySelector('span').textContent;
                });
            });
            document.querySelectorAll('.coming-soon-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    Swal.fire({ icon: 'info', title: 'Feature Under Development', text: 'This feature will be available soon.' });
                });
            });

            // --- General Event Listeners ---
            mobileMenuToggle.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('open'); });
            mainContent.addEventListener('click', () => { if (sidebar.classList.contains('open')) sidebar.classList.remove('open'); });
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                Swal.fire({ title: 'Logout?', icon: 'question', showCancelButton: true, confirmButtonText: 'Yes, Logout' }).then((result) => { if (result.isConfirmed) signOut(auth); });
            });

            // ===============================================
            // === JOB LISTINGS (CRUD) FUNCTIONALITY START ===
            // ===============================================
            // This section is unchanged and correct
            const jobListingModalOverlay = document.getElementById('job-listing-modal-overlay');
            const jobListingModalCloseBtn = document.getElementById('job-listing-modal-close-btn');
            const addNewJobBtn = document.getElementById('add-new-job-btn');
            const jobListingForm = document.getElementById('job-listing-form');
            const jobListingsGrid = document.getElementById('job-listings-grid');
            const openJobListingModal = () => jobListingModalOverlay.classList.add('active');
            const closeJobListingModal = () => jobListingModalOverlay.classList.remove('active');
            addNewJobBtn.addEventListener('click', () => {
                document.getElementById('job-listing-modal-title').textContent = 'Add New Job';
                jobListingForm.reset();
                jobListingForm.querySelector('#job-listing-id').value = '';
                openJobListingModal();
            });
            jobListingsGrid.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-listing');
                if (editBtn) {
                    const docId = editBtn.dataset.id;
                    const docSnap = await getDoc(doc(db, "job-listings", docId));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('job-listing-modal-title').textContent = 'Edit Job Listing';
                        jobListingForm.querySelector('#job-listing-id').value = docId;
                        jobListingForm.querySelector('#job-title').value = data.title;
                        jobListingForm.querySelector('#job-location').value = data.location;
                        jobListingForm.querySelector('#job-type').value = data.type;
                        jobListingForm.querySelector('#job-description').value = data.description;
                        openJobListingModal();
                    }
                }
                const deleteBtn = e.target.closest('.delete-listing');
                if (deleteBtn) {
                    const docId = deleteBtn.dataset.id;
                    Swal.fire({
                        title: 'Delete this job listing?', text: "You won't be able to revert this!", icon: 'warning',
                        showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, delete it!'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            try {
                                await deleteDoc(doc(db, "job-listings", docId));
                                showToast('success', 'Job listing deleted.');
                            } catch (error) { showToast('error', 'Could not delete listing.'); }
                        }
                    });
                }
            });
            jobListingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('save-job-btn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`;
                const jobData = {
                    title: jobListingForm.querySelector('#job-title').value,
                    location: jobListingForm.querySelector('#job-location').value,
                    type: jobListingForm.querySelector('#job-type').value,
                    description: jobListingForm.querySelector('#job-description').value
                };
                const docId = jobListingForm.querySelector('#job-listing-id').value;
                try {
                    if (docId) {
                        await updateDoc(doc(db, "job-listings", docId), jobData);
                        showToast('success', 'Job listing updated!');
                    } else {
                        jobData.createdAt = serverTimestamp();
                        await addDoc(collection(db, "job-listings"), jobData);
                        showToast('success', 'New job listing added!');
                    }
                    closeJobListingModal();
                } catch (error) {
                    showToast('error', 'Could not save listing.');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Job';
                }
            });
            jobListingModalCloseBtn.addEventListener('click', closeJobListingModal);
            jobListingModalOverlay.addEventListener('click', (e) => {
                if (e.target === jobListingModalOverlay) closeJobListingModal();
            });
            const listingsQuery = query(collection(db, "job-listings"), orderBy("createdAt", "desc"));
            onSnapshot(listingsQuery, (snapshot) => {
                jobListingsGrid.innerHTML = '';
                if (snapshot.empty) {
                    jobListingsGrid.innerHTML = `<p class="no-data-message" style="grid-column: 1 / -1;"><i class="fas fa-folder-open"></i><span>No job listings created yet. Click 'Add New Job' to start.</span></p>`;
                    return;
                }
                snapshot.docs.forEach((docSnap, i) => {
                    const listing = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'job-listing-card';
                    card.style.animationDelay = `${i * 50}ms`;
                    card.innerHTML = `
                        <div class="listing-header"><h4>${listing.title}</h4></div>
                        <div class="listing-details">
                            <span><i class="fas fa-map-marker-alt"></i>${listing.location}</span>
                            <span><i class="fas fa-clock"></i>${listing.type}</span>
                        </div>
                        <p class="listing-description">${listing.description}</p>
                        <div class="listing-actions">
                            <button class="btn-action edit-listing" data-id="${docSnap.id}" style="background-color: #3498db;"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-action delete-listing" data-id="${docSnap.id}" style="background-color: #e74c3c;"><i class="fas fa-trash-alt"></i> Delete</button>
                        </div>
                    `;
                    jobListingsGrid.appendChild(card);
                    setTimeout(() => card.classList.add('visible'), 50);
                });
            });


            // =============================================
            // === JOB APPLICATIONS FUNCTIONALITY START ===
            // =============================================
            const applicationsQuery = query(collection(db, "job-applications"), orderBy("submissionDate", "desc"));
            const viewDetailsModalOverlay = document.getElementById('view-details-modal-overlay');
            const viewDetailsCloseBtn = document.getElementById('view-details-close-btn');
            const scheduleModalOverlay = document.getElementById('schedule-modal-overlay');
            const scheduleModalCloseBtn = document.getElementById('schedule-modal-close-btn');
            const scheduleForm = document.getElementById('schedule-form');

            const openScheduleModal = () => scheduleModalOverlay.classList.add('active');
            const closeScheduleModal = () => scheduleModalOverlay.classList.remove('active');

            viewDetailsCloseBtn.addEventListener('click', () => viewDetailsModalOverlay.classList.remove('active'));
            viewDetailsModalOverlay.addEventListener('click', (e) => { if (e.target === viewDetailsModalOverlay) viewDetailsModalOverlay.classList.remove('active'); });
            scheduleModalCloseBtn.addEventListener('click', closeScheduleModal);
            scheduleModalOverlay.addEventListener('click', (e) => { if (e.target === scheduleModalOverlay) closeScheduleModal(); });
            
            // --- UPDATED SCHEDULE FORM LOGIC ---
            scheduleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const confirmScheduleBtn = document.getElementById('confirm-schedule-btn');
                const { docId, name, email, position } = scheduleForm.dataset;
                const interviewDate = document.getElementById('interview-date').value;
                const interviewTime = document.getElementById('interview-time').value;
                const interviewMethod = document.getElementById('interview-method').value;

                if (!docId || !interviewDate || !interviewTime) return showToast('error', 'Please fill all fields.');
                
                const formattedDate = new Date(interviewDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const formattedTime = new Date(`1970-01-01T${interviewTime}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

                const emailBody = `<p style="margin: 0 0 24px 0;">Thank you again for your interest in the <strong>${position}</strong> position. We were impressed with your application and would like to formally invite you for an interview to discuss your qualifications and the role in more detail.</p>
                                 <p style="margin: 0 0 24px 0;"><strong>Interview Details:</strong><br>
                                 • <strong>Date:</strong> ${formattedDate}<br>
                                 • <strong>Time:</strong> ${formattedTime}<br>
                                 • <strong>Method:</strong> ${interviewMethod}</p>
                                 <p style="margin: 0 0 40px 0;">We look forward to speaking with you.</p>`;

                const templateParams = {
                    name,
                    email,
                    subject: `Interview Invitation for ${position} Role`,
                    main_content: emailBody
                };

                confirmScheduleBtn.disabled = true;
                confirmScheduleBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sending...`;
                try {
                    await emailjs.send('service_x0tfbsg', 'template_31k2ywl', templateParams); // <-- UNIVERSAL TEMPLATE
                    await updateDoc(doc(db, "job-applications", docId), { status: 'scheduled', interviewDate, interviewTime, interviewMethod });
                    showToast('success', 'Interview scheduled and invite sent!');
                    closeScheduleModal();
                } catch (error) { 
                    showToast('error', 'Failed to send invite. Check console.'); 
                    console.error("EmailJS Error:", error);
                } finally {
                    confirmScheduleBtn.disabled = false;
                    confirmScheduleBtn.textContent = 'Confirm & Send Invite';
                }
            });

            // --- UPDATED MAIN EVENT LISTENER ---
            mainContent.addEventListener('click', async (e) => {
                const button = e.target.closest('button.btn-action');
                if (!button || !button.dataset.id || button.classList.contains('edit-listing') || button.classList.contains('delete-listing') || button.id === 'add-new-job-btn') return;

                const { id, name, email, position } = button.dataset;

                if (button.classList.contains('schedule')) {
                    scheduleForm.reset();
                    Object.assign(scheduleForm.dataset, { docId: id, name, email, position });
                    openScheduleModal();
                } else if (button.classList.contains('view-details')) {
                    // This is unchanged and correct
                    const docSnap = await getDoc(doc(db, "job-applications", id));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const interviewStatusEl = document.getElementById('detail-interview-status');
                        
                        if (data.interviewDate && data.interviewTime) {
                            const date = new Date(data.interviewDate).toLocaleDateString('en-US', { dateStyle: 'long' });
                            const time = new Date(`1970-01-01T${data.interviewTime}`).toLocaleTimeString('en-US', { timeStyle: 'short' });
                            interviewStatusEl.innerHTML = `<strong>Scheduled:</strong> ${date} at ${time} via ${data.interviewMethod}`;
                        } else {
                            interviewStatusEl.textContent = 'Pending';
                        }
                        
                        document.getElementById('detail-name').textContent = `${data.firstName} ${data.lastName}`;
                        document.getElementById('detail-email').textContent = data.email || 'N/A';
                        document.getElementById('detail-age').textContent = data.age || 'N/A';
                        document.getElementById('detail-degree').textContent = data.degree || 'N/A';
                        document.getElementById('detail-experience').textContent = data.experience || 'Not provided';
                        document.getElementById('detail-resume').innerHTML = `<a href="${data.resumeLink}" target="_blank" rel="noopener noreferrer">${data.resumeLink}</a>`;
                        
                        viewDetailsModalOverlay.classList.add('active');
                    }
                } else if (button.classList.contains('accept')) {
                    Swal.fire({
                        title: 'Accept Application?',
                        text: "This action will send a job offer email to the candidate.",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#28a745',
                        confirmButtonText: 'Yes, Send Offer'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            button.disabled = true;
                            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sending...`;
                            
                            const emailBody = `<p style="margin: 0 0 24px 0;">Following your recent interview process, we are delighted to formally offer you the position of <strong>${position}</strong> at Lifewood!</p>
                                             <p style="margin: 0 0 24px 0;">Your skills and experience were highly impressive, and we believe you will be a valuable asset to our team. This is the beginning of an exciting journey, and we are thrilled to have you be a part of it.</p>
                                             <p style="margin: 0 0 24px 0;">Our HR department will be in touch with you shortly with a formal offer letter, your contract, and details about the onboarding process.</p>
                                             <p style="margin: 0 0 40px 0;">Welcome to the team!</p>`;

                            const templateParams = {
                                name,
                                email,
                                subject: `Job Offer: ${position} at Lifewood`,
                                main_content: emailBody
                            };

                            try {
                                await emailjs.send('service_x0tfbsg', 'template_31k2ywl', templateParams); // <-- UNIVERSAL TEMPLATE
                                
                                await updateDoc(doc(db, "job-applications", id), { status: 'accepted' });
                                showToast('success', 'Offer email sent & status updated!');
                            } catch (error) {
                                showToast('error', 'Could not send offer email.');
                                console.error("EmailJS Error:", error);
                                button.disabled = false;
                                button.innerHTML = `<i class="fas fa-check"></i> Accept`;
                            }
                        }
                    });
                } else if (button.classList.contains('reject')) {
                    Swal.fire({ title: 'Reject Application?', text: "This will send a polite rejection email.", icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, Reject' }).then(async (result) => {
                        if (result.isConfirmed) {
                            try {
                                // This uses the dedicated rejection template, which now also has the correct design.
                                await emailjs.send('service_x0tfbsg', 'template_vhy1ryh', { name, email, position }); // <-- REJECTION TEMPLATE
                                await updateDoc(doc(db, "job-applications", id), { status: 'rejected' });
                                showToast('success', 'Rejection email sent!');
                            } catch (error) { showToast('error', 'Could not send email.'); }
                        }
                    });
                } else if (button.classList.contains('delete')) {
                    Swal.fire({ title: 'Delete Forever?', text: "This action is irreversible.", icon: 'error', showCancelButton: true, confirmButtonText: 'Yes, Delete' }).then(async (result) => {
                        if (result.isConfirmed) {
                            try { await deleteDoc(doc(db, "job-applications", id)); showToast('info', 'Application deleted.'); }
                            catch (error) { showToast('error', 'Could not delete.'); }
                        }
                    });
                }
            });

            // --- onSnapshot for populating tables (unchanged and correct) ---
            onSnapshot(applicationsQuery, (snapshot) => {
                const dashboardTableBody = document.querySelector('#dashboard-applications-table tbody');
                const fullTableBody = document.querySelector('#full-applications-table tbody');
                dashboardTableBody.innerHTML = '';
                fullTableBody.innerHTML = '';

                let accepted = 0, rejected = 0, pending = 0, scheduled = 0;
                const positions = new Set();
                
                if (snapshot.empty) {
                    const noDataRow = `<tr><td colspan="4" class="no-data-message"><i class="fas fa-folder-open"></i><span>No applications submitted yet.</span></td></tr>`;
                    dashboardTableBody.innerHTML = noDataRow;
                    fullTableBody.innerHTML = noDataRow;
                } else {
                    snapshot.docs.forEach((docSnap, i) => {
                        const app = docSnap.data();
                        const { status = 'pending', firstName, lastName, position, email } = app;
                        const applicantName = `${firstName} ${lastName}`;
                        
                        if (status === 'accepted') accepted++; else if (status === 'rejected') rejected++;
                        else if (status === 'scheduled') scheduled++; else pending++;
                        if (position) positions.add(position);

                        const statusHtml = `<span class="status-badge status-${status}">${status}</span>`;
                        const baseRowHtml = `<td>${applicantName}</td><td>${position}</td><td>${statusHtml}</td>`;
                        
                        let fullActionsHtml = `<button class="btn-action view-details" data-id="${docSnap.id}"><i class="fas fa-eye"></i> View Details</button>`;
                        if (status === 'pending') {
                            fullActionsHtml += `<button class="btn-action schedule" data-id="${docSnap.id}" data-name="${applicantName}" data-email="${email}" data-position="${position}"><i class="fas fa-calendar-alt"></i> Schedule</button>`;
                            fullActionsHtml += `<button class="btn-action reject" data-id="${docSnap.id}" data-name="${applicantName}" data-email="${email}" data-position="${position}"><i class="fas fa-times"></i> Reject</button>`;
                        } else if (status === 'scheduled') {
                            fullActionsHtml += `<button class="btn-action accept" data-id="${docSnap.id}" data-name="${applicantName}" data-email="${email}" data-position="${position}"><i class="fas fa-check"></i> Accept</button>`;
                            fullActionsHtml += `<button class="btn-action reject" data-id="${docSnap.id}" data-name="${applicantName}" data-email="${email}" data-position="${position}"><i class="fas fa-times"></i> Reject</button>`;
                        } else {
                            fullActionsHtml += `<button class="btn-action delete" data-id="${docSnap.id}"><i class="fas fa-trash-alt"></i> Delete</button>`;
                        }
                        
                        const dashboardActionsHtml = `<button class="btn-action view-details" data-id="${docSnap.id}"><i class="fas fa-eye"></i> View</button>`;

                        const fullTr = document.createElement('tr');
                        fullTr.innerHTML = `${baseRowHtml}<td><div class="action-buttons">${fullActionsHtml}</div></td>`;
                        fullTr.style.animationDelay = `${i * 50}ms`;
                        fullTr.classList.add('row-visible');
                        fullTableBody.appendChild(fullTr);

                        if (i < 5) {
                            const dashTr = document.createElement('tr');
                            dashTr.innerHTML = `${baseRowHtml}<td><div class="action-buttons">${dashboardActionsHtml}</div></td>`;
                            dashTr.style.animationDelay = `${i * 50}ms`;
                            dashTr.classList.add('row-visible');
                            dashboardTableBody.appendChild(dashTr);
                        }
                    });
                }
                
                document.getElementById('application-count-badge').textContent = snapshot.size;
                document.getElementById('total-applicants-stat').textContent = snapshot.size;
                document.getElementById('accepted-stat').textContent = accepted;
                document.getElementById('rejected-stat').textContent = rejected;
                document.getElementById('pending-stat').textContent = pending + scheduled;
                document.getElementById('positions-stat').textContent = positions.size;
            });
        }
    </script>
</body>
</html>
